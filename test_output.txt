
> bishl-app@0.1.0 test
> jest __tests__/lib/apiClient.test.ts

  console.error
    Error: Not implemented: navigation (except hash changes)
        at module.exports (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/browser/not-implemented.js:9:17)
        at navigateFetch (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/living/window/navigation.js:77:3)
        at exports.navigate (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/living/window/navigation.js:55:3)
        at LocationImpl._locationObjectNavigate (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/living/window/Location-impl.js:30:5)
        at LocationImpl._locationObjectSetterNavigate (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/living/window/Location-impl.js:24:17)
        at LocationImpl.set href [as href] (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/living/window/Location-impl.js:46:10)
        at Location.set href [as href] (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/living/generated/Location.js:125:37)
        at Reflect.set (<anonymous>)
        at Window.set location [as location] (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/browser/Window.js:424:15)
        at Object.<anonymous> (/home/runner/workspace/__tests__/lib/apiClient.test.ts:33:25)
        at Runtime._execModule (/home/runner/workspace/node_modules/jest-runtime/build/index.js:1268:24)
        at Runtime._loadModule (/home/runner/workspace/node_modules/jest-runtime/build/index.js:944:12)
        at Runtime.requireModule (/home/runner/workspace/node_modules/jest-runtime/build/index.js:832:12)
        at jestAdapter (/home/runner/workspace/node_modules/jest-circus/build/runner.js:95:13)
        at runTestInternal (/home/runner/workspace/node_modules/jest-runner/build/index.js:275:16)
        at runTest (/home/runner/workspace/node_modules/jest-runner/build/index.js:343:7) {
      type: 'not implemented'
    }

      31 |
      32 | delete (window as any).location;
    > 33 | (window as any).location = {
         |                         ^
      34 |   get href() {
      35 |     return mockHref;
      36 |   },

      at VirtualConsole.<anonymous> (node_modules/@jest/environment-jsdom-abstract/build/index.js:87:23)
          at Reflect.set (<anonymous>)
      at Object.<anonymous> (__tests__/lib/apiClient.test.ts:33:25)

  console.error
    Error: Not implemented: navigation (except hash changes)
        at module.exports (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/browser/not-implemented.js:9:17)
        at navigateFetch (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/living/window/navigation.js:77:3)
        at exports.navigate (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/living/window/navigation.js:55:3)
        at LocationImpl._locationObjectNavigate (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/living/window/Location-impl.js:30:5)
        at LocationImpl._locationObjectSetterNavigate (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/living/window/Location-impl.js:24:17)
        at LocationImpl.set href [as href] (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/living/window/Location-impl.js:46:10)
        at Location.set href [as href] (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/living/generated/Location.js:125:37)
        at /home/runner/workspace/lib/apiClient.tsx:178:35
        at Axios.request (/home/runner/workspace/node_modules/axios/lib/core/Axios.js:40:14)
        at Object.<anonymous> (/home/runner/workspace/__tests__/lib/apiClient.test.ts:268:7) {
      type: 'not implemented'
    }

      176 |             // Only redirect if not already on login page
      177 |             if (!window.location.pathname.includes('/login')) {
    > 178 |               window.location.href = '/login';
          |                                   ^
      179 |             }
      180 |           }
      181 |           

      at VirtualConsole.<anonymous> (node_modules/@jest/environment-jsdom-abstract/build/index.js:87:23)
      at lib/apiClient.tsx:178:35
      at Axios.request (node_modules/axios/lib/core/Axios.js:40:14)
      at Object.<anonymous> (__tests__/lib/apiClient.test.ts:268:7)

  console.error
    Error: Not implemented: navigation (except hash changes)
        at module.exports (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/browser/not-implemented.js:9:17)
        at navigateFetch (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/living/window/navigation.js:77:3)
        at exports.navigate (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/living/window/navigation.js:55:3)
        at LocationImpl._locationObjectNavigate (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/living/window/Location-impl.js:30:5)
        at LocationImpl._locationObjectSetterNavigate (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/living/window/Location-impl.js:24:17)
        at LocationImpl.set href [as href] (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/living/window/Location-impl.js:46:10)
        at Location.set href [as href] (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/living/generated/Location.js:125:37)
        at /home/runner/workspace/lib/apiClient.tsx:190:31
        at Axios.request (/home/runner/workspace/node_modules/axios/lib/core/Axios.js:40:14)
        at Object.<anonymous> (/home/runner/workspace/__tests__/lib/apiClient.test.ts:282:7) {
      type: 'not implemented'
    }

      188 |         isRefreshing = false;
      189 |         if (typeof window !== 'undefined' && !window.location.pathname.includes('/login')) {
    > 190 |           window.location.href = '/login';
          |                               ^
      191 |         }
      192 |       }
      193 |     }

      at VirtualConsole.<anonymous> (node_modules/@jest/environment-jsdom-abstract/build/index.js:87:23)
      at lib/apiClient.tsx:190:31
      at Axios.request (node_modules/axios/lib/core/Axios.js:40:14)
      at Object.<anonymous> (__tests__/lib/apiClient.test.ts:282:7)

  console.error
    Error: Not implemented: navigation (except hash changes)
        at module.exports (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/browser/not-implemented.js:9:17)
        at navigateFetch (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/living/window/navigation.js:77:3)
        at exports.navigate (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/living/window/navigation.js:55:3)
        at LocationImpl._locationObjectNavigate (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/living/window/Location-impl.js:30:5)
        at LocationImpl._locationObjectSetterNavigate (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/living/window/Location-impl.js:24:17)
        at LocationImpl.set href [as href] (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/living/window/Location-impl.js:46:10)
        at Location.set href [as href] (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/living/generated/Location.js:125:37)
        at /home/runner/workspace/lib/apiClient.tsx:190:31
        at Axios.request (/home/runner/workspace/node_modules/axios/lib/core/Axios.js:40:14)
        at Object.<anonymous> (/home/runner/workspace/__tests__/lib/apiClient.test.ts:294:7) {
      type: 'not implemented'
    }

      188 |         isRefreshing = false;
      189 |         if (typeof window !== 'undefined' && !window.location.pathname.includes('/login')) {
    > 190 |           window.location.href = '/login';
          |                               ^
      191 |         }
      192 |       }
      193 |     }

      at VirtualConsole.<anonymous> (node_modules/@jest/environment-jsdom-abstract/build/index.js:87:23)
      at lib/apiClient.tsx:190:31
      at Axios.request (node_modules/axios/lib/core/Axios.js:40:14)
      at Object.<anonymous> (__tests__/lib/apiClient.test.ts:294:7)

  console.log
    Retrying request (attempt 1/3)

      at log (lib/apiClient.tsx:203:15)

  console.log
    Retrying request (attempt 1/3)

      at log (lib/apiClient.tsx:203:15)

  console.log
    Retrying request (attempt 1/3)

      at log (lib/apiClient.tsx:203:15)

  console.log
    Retrying request (attempt 1/3)

      at log (lib/apiClient.tsx:203:15)

  console.log
    Retrying request (attempt 1/3)

      at log (lib/apiClient.tsx:203:15)

  console.error
    Error: Not implemented: navigation (except hash changes)
        at module.exports (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/browser/not-implemented.js:9:17)
        at navigateFetch (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/living/window/navigation.js:77:3)
        at exports.navigate (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/living/window/navigation.js:55:3)
        at LocationImpl._locationObjectNavigate (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/living/window/Location-impl.js:30:5)
        at LocationImpl._locationObjectSetterNavigate (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/living/window/Location-impl.js:24:17)
        at LocationImpl.set href [as href] (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/living/window/Location-impl.js:46:10)
        at Location.set href [as href] (/home/runner/workspace/node_modules/jest-environment-jsdom/node_modules/jsdom/lib/jsdom/living/generated/Location.js:125:37)
        at /home/runner/workspace/lib/apiClient.tsx:178:35
        at runNextTicks (node:internal/process/task_queues:60:5)
        at listOnTimeout (node:internal/timers:538:9)
        at processTimers (node:internal/timers:512:7)
        at Axios.request (/home/runner/workspace/node_modules/axios/lib/core/Axios.js:40:14)
        at Object.<anonymous> (/home/runner/workspace/__tests__/lib/apiClient.test.ts:411:7) {
      type: 'not implemented'
    }

      176 |             // Only redirect if not already on login page
      177 |             if (!window.location.pathname.includes('/login')) {
    > 178 |               window.location.href = '/login';
          |                                   ^
      179 |             }
      180 |           }
      181 |           

      at VirtualConsole.<anonymous> (node_modules/@jest/environment-jsdom-abstract/build/index.js:87:23)
      at lib/apiClient.tsx:178:35
      at Axios.request (node_modules/axios/lib/core/Axios.js:40:14)
      at Object.<anonymous> (__tests__/lib/apiClient.test.ts:411:7)

FAIL __tests__/lib/apiClient.test.ts (5.764 s)
  lib/apiClient.tsx - API Client
    Request Interceptor
      ✓ should add Authorization header when access token exists (8 ms)
      ✓ should not add Authorization header when no access token exists (3 ms)
      ✓ should add CSRF token to POST requests (2 ms)
      ✓ should add CSRF token to PUT, PATCH, DELETE requests (3 ms)
      ✓ should not add CSRF token to GET requests (2 ms)
    Response Interceptor - Unwrapping
      ✓ should unwrap standardized success response (3 ms)
      ✓ should preserve pagination metadata (3 ms)
      ✓ should return response as-is if not standardized format (3 ms)
    Token Refresh Logic
      ✓ should refresh token on 401 error and retry original request (10 ms)
      ✓ should queue multiple requests during token refresh (20 ms)
      ✕ should redirect to login when refresh token fails (242 ms)
      ✕ should redirect to login when no refresh token exists (15 ms)
      ✓ should not redirect to login if already on login page (14 ms)
    Retry Logic
      ✕ should retry on network errors up to MAX_RETRIES (2 ms)
      ✓ should retry on timeout errors (1010 ms)
      ✓ should retry on 500, 502, 503, 504 errors (4016 ms)
      ✓ should not retry on 501, 505, 511 errors (3 ms)
      ✓ should not retry on 400 errors (2 ms)
      ✕ should fail after MAX_RETRIES attempts (2 ms)
    Request Cancellation
      ✓ should support request cancellation (1 ms)
      ✓ should export CancelToken and isCancel
    Edge Cases
      ✓ should handle response without data field (1 ms)
      ✓ should handle empty response (1 ms)
      ✓ should not retry 401 errors more than once (token refresh only) (3 ms)

  ● lib/apiClient.tsx - API Client › Token Refresh Logic › should redirect to login when refresh token fails

    expect(received).toBe(expected) // Object.is equality

    Expected: "/login"
    Received: ""

      270 |       expect(localStorageMock.getItem('access_token')).toBeNull();
      271 |       expect(localStorageMock.getItem('refresh_token')).toBeNull();
    > 272 |       expect(mockHref).toBe('/login');
          |                        ^
      273 |     });
      274 |
      275 |     it('should redirect to login when no refresh token exists', async () => {

      at Object.toBe (__tests__/lib/apiClient.test.ts:272:24)

  ● lib/apiClient.tsx - API Client › Token Refresh Logic › should redirect to login when no refresh token exists

    expect(received).toBe(expected) // Object.is equality

    Expected: "/login"
    Received: ""

      282 |       await expect(apiClient.get('/protected')).rejects.toThrow();
      283 |
    > 284 |       expect(mockHref).toBe('/login');
          |                        ^
      285 |     });
      286 |
      287 |     it('should not redirect to login if already on login page', async () => {

      at Object.toBe (__tests__/lib/apiClient.test.ts:284:24)

  ● lib/apiClient.tsx - API Client › Retry Logic › should retry on network errors up to MAX_RETRIES

    Network Error

      305 |       mock.onGet('/test').reply(200, { success: true, data: { message: 'ok' } });
      306 |
    > 307 |       const response = await apiClient.get('/test');
          |                        ^
      308 |       expect(response.data).toEqual({ message: 'ok' });
      309 |       expect(mock.history.get.length).toBe(3);
      310 |     });

      at Function.AxiosError.from (node_modules/axios/lib/core/AxiosError.js:96:14)
      at Object.createAxiosError (node_modules/axios-mock-adapter/src/utils.js:161:29)
      at node_modules/axios-mock-adapter/src/index.js:208:23
      at makeResponse (node_modules/axios-mock-adapter/src/utils.js:123:52)
      at Object.settle (node_modules/axios-mock-adapter/src/utils.js:142:24)
      at handleRequest (node_modules/axios-mock-adapter/src/handle_request.js:61:20)
      at node_modules/axios-mock-adapter/src/index.js:54:24
      at Axios.dispatchRequest (node_modules/axios/lib/core/dispatchRequest.js:51:10)
      at Axios.request (node_modules/axios/lib/core/Axios.js:40:14)
      at Object.<anonymous> (__tests__/lib/apiClient.test.ts:307:24)
      at Axios.request (node_modules/axios/lib/core/Axios.js:45:41)
      at Object.<anonymous> (__tests__/lib/apiClient.test.ts:307:24)

    Cause:
    Network Error

      305 |       mock.onGet('/test').reply(200, { success: true, data: { message: 'ok' } });
      306 |
    > 307 |       const response = await apiClient.get('/test');
          |                        ^
      308 |       expect(response.data).toEqual({ message: 'ok' });
      309 |       expect(mock.history.get.length).toBe(3);
      310 |     });

      at Object.createAxiosError (node_modules/axios-mock-adapter/src/utils.js:161:34)
      at node_modules/axios-mock-adapter/src/index.js:208:23
      at makeResponse (node_modules/axios-mock-adapter/src/utils.js:123:52)
      at Object.settle (node_modules/axios-mock-adapter/src/utils.js:142:24)
      at handleRequest (node_modules/axios-mock-adapter/src/handle_request.js:61:20)
      at node_modules/axios-mock-adapter/src/index.js:54:24
      at Axios.dispatchRequest (node_modules/axios/lib/core/dispatchRequest.js:51:10)
      at Axios.request (node_modules/axios/lib/core/Axios.js:40:14)
      at Object.<anonymous> (__tests__/lib/apiClient.test.ts:307:24)

  ● lib/apiClient.tsx - API Client › Retry Logic › should fail after MAX_RETRIES attempts

    expect(received).toBe(expected) // Object.is equality

    Expected: 4
    Received: 1

      361 |
      362 |       await expect(apiClient.get('/test')).rejects.toThrow();
    > 363 |       expect(mock.history.get.length).toBe(4); // 1 initial + 3 retries
          |                                       ^
      364 |     });
      365 |   });
      366 |

      at Object.toBe (__tests__/lib/apiClient.test.ts:363:39)

Test Suites: 1 failed, 1 total
Tests:       4 failed, 20 passed, 24 total
Snapshots:   0 total
Time:        6.242 s
Ran all test suites matching __tests__/lib/apiClient.test.ts.
